import{ab as t,H as e,I as o,G as n,V as s,O as p,ac as c,Y as l}from"./framework-c2f60e5e.js";const i={},r=n("h1",{id:"gzctf部署笔记",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#gzctf部署笔记","aria-hidden":"true"},"#"),s(" GZCTF部署笔记")],-1),u={href:"https://github.com/GZTimeWalker/GZCTF",target:"_blank",rel:"noopener noreferrer"},d=n("p",null,"部署方式：Docker-compose（GZCTF、数据库、题目容器均在同一Docker实例中）",-1),k=n("p",null,"服务器：腾讯云轻量应用服务器 2核2G",-1),v=n("p",null,"系统：Ubuntu20.04-Docker20（因此默认系统已经安装了Docker和Docker Compose）",-1),m=c(`<h2 id="将当前用户加入docker组" tabindex="-1"><a class="header-anchor" href="#将当前用户加入docker组" aria-hidden="true">#</a> 将当前用户加入docker组</h2><p>若出现下面的报错才需配置。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>xxxx@xxxx ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> <span class="token function">ps</span>
Got permission denied <span class="token keyword">while</span> trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get <span class="token string">&quot;http://%2Fvar%2Frun%2Fdocker.sock/v1.24/containers/json&quot;</span><span class="token builtin class-name">:</span> dial unix /var/run/docker.sock: connect: permission denied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>问题出在用户为访问/var/run/docker.sock的权限，只需给用户增加权限即可。命令行输入：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chown</span> root:docker /var/run/docker.sock	<span class="token comment"># 修改docker.sock权限为root:docker</span>
<span class="token function">sudo</span> <span class="token function">groupadd</span> <span class="token function">docker</span>          				<span class="token comment"># 添加docker用户组 </span>
<span class="token function">sudo</span> gpasswd <span class="token parameter variable">-a</span> <span class="token environment constant">$USER</span> <span class="token function">docker</span>  				<span class="token comment"># 将当前用户添加至docker用户组</span>
newgrp <span class="token function">docker</span>                 				<span class="token comment"># 更新docker用户组</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置文件" tabindex="-1"><a class="header-anchor" href="#配置文件" aria-hidden="true">#</a> 配置文件</h2><p>新建两个文件，位于同一个文件夹。这里的文件夹名称为<code>GZCTF</code>，文件为<code>appsettings.json</code>和<code>docker-compose.yml</code>。</p><p><code>appsettings.json</code>文件内写入：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;AllowedHosts&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ConnectionStrings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;Database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Host=db:5432;Database=gzctf;Username=postgres;Password=&lt;String1&gt;&quot;</span>
      <span class="token comment">//&lt;String1&gt;换成数据库密码，随机密码且长度足够</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Logging&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;LogLevel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;Default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Information&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;Microsoft&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Warning&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Information&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//邮箱配置</span>
  <span class="token property">&quot;EmailConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;SendMailAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Admin@xxx.com&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 填入邮箱</span>
    <span class="token property">&quot;UserName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctf_noreply&quot;</span><span class="token punctuation">,</span>				<span class="token comment">// 发件人名称</span>
    <span class="token property">&quot;Password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UWPTINWMFPQVMPAH&quot;</span><span class="token punctuation">,</span>			<span class="token comment">// 邮箱密码，部分服务商需要填入授权码</span>
    <span class="token property">&quot;Smtp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;Host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;smtp.163.com&quot;</span><span class="token punctuation">,</span>				<span class="token comment">// 此处为163邮箱服务器，具体自定</span>
      <span class="token property">&quot;Port&quot;</span><span class="token operator">:</span> <span class="token number">465</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;XorKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;String2&gt;&quot;</span><span class="token punctuation">,</span>					<span class="token comment">// 自定XorKey</span>
  <span class="token property">&quot;ContainerProvider&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Docker&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;PublicEntry&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xx.xx.xx.xx&quot;</span><span class="token punctuation">,</span>			<span class="token comment">// 域名或IP配置，用于容器生成,域名不带http/https</span>
    <span class="token property">&quot;DockerConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;SwarmMode&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;Uri&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>								<span class="token comment">// 本地配置Docker因此此处置空</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;RequestLogging&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;DisableRateLimit&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;RegistryConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;UserName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ServerAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">//谷歌验证码配置</span>
  <span class="token property">&quot;GoogleRecaptcha&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;VerifyAPIAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://www.recaptcha.net/recaptcha/api/siteverify&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Sitekey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Secretkey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;RecaptchaThreshold&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.5&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>docker-compose.yml</code>写入：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#39;3.0&#39;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gzctf</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gztime/gzctf<span class="token punctuation">:</span>latest
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;GZCTF_ADMIN_PASSWORD=&lt;String3&gt;&quot;</span> <span class="token comment"># &lt;String3&gt;换成管理员账户密码，账号为Admin</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;80:80&quot;</span> <span class="token comment"># 对外端口号，前为外部端口。</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./data/files:/app/uploads&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./appsettings.json:/app/appsettings.json:ro&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./logs:/app/log&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./data/keys:/root/.aspnet/DataProtection-Keys&quot;</span>
      <span class="token comment"># - &quot;./k8sconfig.yaml:/app/k8sconfig.yaml:ro&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db

  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>alpine
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;POSTGRES_PASSWORD=&lt;String1&gt;&quot;</span> <span class="token comment"># 数据库密码，务必要和appsettings.json中的配置一致</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./data/db:/var/lib/postgresql/data&quot;</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
    <span class="token key atrule">ipam</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">subnet</span><span class="token punctuation">:</span> 192.168.12.0/24

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="命令行" tabindex="-1"><a class="header-anchor" href="#命令行" aria-hidden="true">#</a> 命令行</h2><p>通过Xshell和Xftp连接服务器，上传<code>GZCTF</code>文件夹。开始部署。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> GZCTF
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>部署完成后，建议查看Logs，看部署是否成功。主要是看gzctf容器是否连接上了数据库。</p><p><code>docker ps</code>查看容器ID：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ubuntu@VM-16-8-ubuntu:~$ <span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID   IMAGE                 COMMAND                  CREATED        STATUS        PORTS                NAMES
5b9bc7a475h2   gztime/gzctf:latest   <span class="token string">&quot;dotnet CTFServer.dll&quot;</span>   <span class="token number">17</span> hours ago   Up <span class="token number">17</span> hours   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp   gzctf_gzctf_1
f00e8850dee4   postgres:alpine       <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">17</span> hours ago   Up <span class="token number">17</span> hours   <span class="token number">5432</span>/tcp             gzctf_db_1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看到gzctf的ID是<code>5b9bc7a475h2</code>。使用<code>docker logs 5b9bc7a475h2</code>查看日志。看到连接上数据库的日志即可成功配置。</p><h2 id="平台测试" tabindex="-1"><a class="header-anchor" href="#平台测试" aria-hidden="true">#</a> 平台测试</h2><p>登录域名或IP（域名需要在域名服务商配置）。用Admin和前面设置的密码登录。（中间就自己添加比赛什么的）然后添加需要容器的题目，并测试几个Web容器。</p><figure><img src="http://picgo-1258675557.cos.accelerate.myqcloud.com/202304011351351.png?imageMogr2/quality/70/strip|watermark/2/text/wqkgMHhmLiBEYWFpaGFuZyBXb25n/font/U1RIZWl0aSBMaWdodOWNjuaWh-m7keS9ky50dGM/fontsize/18/fill/I2ZmZmZmZg/dissolve/70/shadow/40/gravity/southeast/dx/10/dy/10|watermark/3/type/3/text/V2FuZ0RhaGVuZ0RhYWloYW5nV29uZ1dESA" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以测试的Docker Hub镜像如下。这些镜像本身部署是没有问题的。若出现错误就是平台配置问题了。服务端口均为80。</p><blockquote><p>vaalacat/push_f12</p><p>glzjin/hctf_2018_warmup</p><p>ctftraining/hbctf_2017_dameixian</p><p>ctftraining/qwb_2019_smarthacker</p><p>ctftraining/buuctf_2018_online_tool</p><p>ctftraining/qwb_2019_upload</p><p>ctftraining/qwb_2019_supersqli</p></blockquote><p>需要注意的是，<strong>部分镜像需要内存和存储较多，可能出现创建容器成功但无法打开网页的情况</strong>。</p><h2 id="容器其他错误排查" tabindex="-1"><a class="header-anchor" href="#容器其他错误排查" aria-hidden="true">#</a> 容器其他错误排查</h2><ul><li><p>部署报错：</p><ul><li>不会两个文件内容改都不改吧？</li><li>检查pip版本，检查Docker版本。</li></ul></li><li><p>容器无法创建：数据库是否连上？看前面的配置和<code>docker logs xxx</code>命令。</p></li><li><p>容器创建成功但无法打开网页：</p><ul><li>域名访问：服务商的域名配置是否正确？</li><li>内存限制和存储限制是否太小？</li><li>服务器的防火墙端口是否打开了？</li></ul></li></ul>`,26);function b(g,q){const a=l("ExternalLinkIcon");return e(),o("div",null,[r,n("blockquote",null,[n("p",null,[s("Github: "),n("a",u,[s("GZTimeWalker/GZCTF"),p(a)])]),d,k,v]),m])}const y=t(i,[["render",b],["__file","GZCTF部署笔记.html.vue"]]);export{y as default};
